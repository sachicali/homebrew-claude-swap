#!/usr/bin/env bash

# Claude Swap - Modular Configuration Manager
# Main entry point script with TIGERSTYLE modular architecture

readonly VERSION="1.2.8"

# Determine script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export CLAUDE_SWAP_BASE_DIR="$SCRIPT_DIR"

# Dynamically locate lib directory - works for both Homebrew and source installs
LIB_DIR=""
CLAUDE_SWAP_BASE_DIR="$SCRIPT_DIR"
if [[ -d "$SCRIPT_DIR/lib" ]]; then
    # Source installation: lib/ in same directory as script
    LIB_DIR="$SCRIPT_DIR/lib"
elif [[ -d "/opt/homebrew/Cellar/claudeswap" ]]; then
    # Homebrew installation: find lib/ in the actual Cellar version directory
    # Try to find the most recent version
    latest_version=$(ls -t /opt/homebrew/Cellar/claudeswap 2>/dev/null | head -1)
    if [[ -n "$latest_version" ]]; then
        # Homebrew installs to libexec/lib
        if [[ -d "/opt/homebrew/Cellar/claudeswap/$latest_version/libexec/lib" ]]; then
            LIB_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version/libexec/lib"
            # Also update base dir to libexec so modular files can find dependencies via ${CLAUDE_SWAP_BASE_DIR}/lib/
            CLAUDE_SWAP_BASE_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version/libexec"
        # Fallback for source installs
        elif [[ -d "/opt/homebrew/Cellar/claudeswap/$latest_version/lib" ]]; then
            LIB_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version/lib"
            CLAUDE_SWAP_BASE_DIR="/opt/homebrew/Cellar/claudeswap/$latest_version"
        fi
    fi
fi

# Fallback: use script directory if nothing else works
if [[ -z "$LIB_DIR" ]]; then
    LIB_DIR="$SCRIPT_DIR/lib"
fi

# Guard against multiple sourcing
[[ -z "${CLAUDESWAP_LOADED:-}" ]] || return 0
readonly CLAUDESWAP_LOADED=1

# Source all modular components with absolute paths
source "$LIB_DIR/constants.sh"
source "$LIB_DIR/logging.sh"
source "$LIB_DIR/utils/cache.sh"
source "$LIB_DIR/utils/formatter.sh"
source "$LIB_DIR/models.sh"
source "$LIB_DIR/sessions.sh"
source "$LIB_DIR/providers/model_fetch.sh"
source "$LIB_DIR/credentials.sh"

# ============================================================================
# COMMAND HANDLERS
# ============================================================================

handle_status() {
    local current_provider=""
    local current_model=""

    # Detect current provider
    if [[ -f "$SETTINGS_FILE" ]]; then
        current_provider=$(jq -r '.env.ANTHROPIC_AUTH_TOKEN // empty' "$SETTINGS_FILE" 2>/dev/null | grep -q "sk-ant" && echo "standard" || echo "unknown")
        if [[ "$current_provider" == "unknown" ]] && [[ -n "$ZAI_API_KEY" ]]; then
            current_provider="zai"
        fi
        if [[ "$current_provider" == "unknown" ]] && [[ -n "$MINIMAX_API_KEY" ]]; then
            current_provider="minimax"
        fi
    fi

    # Get current model
    if [[ -d "$CLAUDE_SESSION_DIR" ]] && [[ "$(ls -A "$CLAUDE_SESSION_DIR" 2>/dev/null)" ]]; then
        local latest_session=$(ls -t "$CLAUDE_SESSION_DIR"/*.json 2>/dev/null | head -1)
        if [[ -n "$latest_session" ]]; then
            current_model=$(extract_session_model "$latest_session")
        fi
    fi

    # Display status
    echo ""
    echo "┌──────────────────────────────────────────┐"
    echo "│           CLAUDE SWAP STATUS             │"
    echo "├──────────────────────────────────────────┤"
    echo "│ Provider:  ${current_provider:-none}                │"
    echo "│ Model:     ${current_model:-unknown}           │"
    echo "│ Sessions:  $(ls -1 "$CLAUDE_SESSION_DIR"/*.json 2>/dev/null | wc -l | tr -d ' ') session files              │"
    echo "└──────────────────────────────────────────┘"
    echo ""

    # Show available providers
    echo "Available providers:"
    echo "  • standard - Anthropic API (claude-3-5-sonnet, claude-3-haiku)"
    echo "  • zai      - Z.ai API (GLM models: glm-4.6, glm-4.5)"
    echo "  • minimax  - MiniMax API (MiniMax-M2, MiniMax-M1)"
    echo "  • kimi     - Kimi/Moonshot API (moonshot-v1-256k, kimi-k2)"
    echo ""
}

handle_test_models() {
    local provider="${1:-}"
    local models=()
    local max_providers=10  # NASA Rule 2: Fixed loop bound

    if [[ -z "$provider" ]]; then
        log_info "Testing all providers..."
        local count=0
        for prov in standard zai minimax kimi; do
            if [[ $count -ge $max_providers ]]; then
                break
            fi
            log_info "Checking $prov models..."
            local prov_models=($(fetch_available_models "$prov"))
            echo "  $prov: ${prov_models[*]:-none}"
            count=$((count + 1))
        done
    else
        models=($(fetch_available_models "$provider"))
        echo "Available models for $provider:"
        local max_models=100  # NASA Rule 2: Fixed loop bound
        local idx=0
        for model in "${models[@]}"; do
            if [[ $idx -ge $max_models ]]; then
                break
            fi
            echo "  • $model$(get_model_details "$model" "$provider")"
            idx=$((idx + 1))
        done
    fi
}

handle_set() {
    local provider="$1"
    local model="$2"

    validate_provider "$provider" || return 1

    # Map model to provider's equivalent
    if [[ -n "$model" ]]; then
        model=$(map_model_to_provider "$model" "$provider")
    fi

    case "$provider" in
        "standard")
            setup_anthropic_credentials
            ;;
        "zai")
            setup_zai_credentials
            ;;
        "minimax")
            setup_minimax_credentials
            ;;
        "kimi")
            setup_kimi_credentials
            ;;
    esac

    # Update settings file with correct auth token path
    if [[ ! -d "$(dirname "$SETTINGS_FILE")" ]]; then
        mkdir -p "$(dirname "$SETTINGS_FILE")"
    fi

    # Ensure settings file exists with proper structure
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        echo '{"env":{"ANTHROPIC_AUTH_TOKEN":"","API_TIMEOUT_MS":"120000"}}' > "$SETTINGS_FILE"
    fi

    # Update authentication token based on provider
    local auth_token=""
    local timeout_ms=""
    local base_url=""

    case "$provider" in
        "standard")
            auth_token="${ANTHROPIC_API_KEY:-}"
            timeout_ms="${STANDARD_TIMEOUT:-120000}"
            base_url=""  # Standard Anthropic uses default API endpoint (no BASE_URL key)
            ;;
        "zai")
            auth_token="${ZAI_API_KEY:-}"
            timeout_ms="${ZAI_TIMEOUT:-3000000}"
            base_url="${ZAI_BASE_URL:-$ZAI_BASE_URL_DEFAULT}"
            ;;
        "minimax")
            auth_token="${MINIMAX_API_KEY:-}"
            timeout_ms="${MINIMAX_TIMEOUT:-3000000}"
            base_url="${MINIMAX_BASE_URL:-$MINIMAX_BASE_URL_DEFAULT}"
            ;;
        "kimi")
            auth_token="${KIMI_API_KEY:-}"
            timeout_ms="${KIMI_TIMEOUT:-3000000}"
            base_url="${KIMI_BASE_URL:-$KIMI_BASE_URL_DEFAULT}"
            ;;
    esac

    if [[ -z "$auth_token" ]]; then
        log_error "No authentication token available for $provider"
        log_info "Run: claudeswap setup"
        return 1
    fi

    # Update settings.json with provider-specific configuration
    # NASA Rule 7: Check all return values
    local jq_result=0
    if [[ -n "$base_url" ]]; then
        # Proxy providers (Z.ai, MiniMax, Kimi): Set ANTHROPIC_BASE_URL
        jq ".env.ANTHROPIC_AUTH_TOKEN = \"$auth_token\" | .env.API_TIMEOUT_MS = \"$timeout_ms\" | .env.ANTHROPIC_BASE_URL = \"$base_url\"" "$SETTINGS_FILE" > "${SETTINGS_FILE}.tmp"
        jq_result=$?
    else
        # Standard Anthropic: Remove ANTHROPIC_BASE_URL if it exists
        jq ".env.ANTHROPIC_AUTH_TOKEN = \"$auth_token\" | .env.API_TIMEOUT_MS = \"$timeout_ms\" | del(.env.ANTHROPIC_BASE_URL)" "$SETTINGS_FILE" > "${SETTINGS_FILE}.tmp"
        jq_result=$?
    fi

    if [[ $jq_result -eq 0 ]]; then
        if ! mv "${SETTINGS_FILE}.tmp" "$SETTINGS_FILE"; then
            log_error "Failed to save settings file"
            rm -f "${SETTINGS_FILE}.tmp"
            return 1
        fi
        log_success "Switched to $provider$([[ -n "$model" ]] && echo " (model: $model)")$([[ -n "$base_url" ]] && echo " at $base_url")"
    else
        log_error "Failed to update settings file"
        rm -f "${SETTINGS_FILE}.tmp"
        return 1
    fi
    return 0
}

handle_setup() {
    # NASA Rule 7: Check return value
    if ! setup_credentials_interactive; then
        log_error "Setup failed or was cancelled"
        return 1
    fi
    return 0
}

handle_backup() {
    # NASA Rule 7: Check return values
    if ! create_session_backup_dir; then
        log_error "Failed to create backup directory"
        return 1
    fi

    local backup_path=$(backup_sessions)
    if [[ -n "$backup_path" ]]; then
        log_success "Sessions backed up to: $backup_path"
        return 0
    fi
    return 1
}

handle_clear() {
    # NASA Rule 7: Check return value
    if ! clear_sessions; then
        log_error "Failed to clear sessions"
        return 1
    fi
    return 0
}

# ============================================================================
# VALIDATION FUNCTIONS
# ============================================================================

validate_provider() {
    local provider="$1"

    case "$provider" in
        standard|zai|minimax|kimi|moonshot)
            return 0
            ;;
        *)
            log_error "Invalid provider: $provider"
            log_info "Valid providers: standard, zai, minimax, kimi"
            return 1
            ;;
    esac
}

# ============================================================================
# MAIN ENTRY POINT
# ============================================================================

main() {
    local command="${1:-}"
    shift || true

    case "$command" in
        "status")
            handle_status
            ;;
        "test-models")
            handle_test_models "$@"
            ;;
        "set")
            if [[ $# -lt 1 ]]; then
                log_error "Usage: claudeswap set <provider> [model]"
                return 1
            fi
            handle_set "$@"
            ;;
        "setup")
            handle_setup
            ;;
        "backup")
            handle_backup
            ;;
        "clear")
            handle_clear
            ;;
        "version"|"--version"|"-v")
            echo "claudeswap version $VERSION"
            ;;
        "help"|"--help"|"-h")
            echo "Claude Swap - Configuration Manager"
            echo ""
            echo "Usage: claudeswap <command> [options]"
            echo ""
            echo "Commands:"
            echo "  status         Show current configuration status"
            echo "  test-models    Test and display available models"
            echo "  set <provider> Switch to specified provider"
            echo "  setup          Interactive credential setup"
            echo "  backup         Backup current sessions"
            echo "  clear          Clear all sessions"
            echo "  version        Show version information"
            echo "  help           Show this help message"
            echo ""
            echo "Examples:"
            echo "  claudeswap status"
            echo "  claudeswap test-models zai"
            echo "  claudeswap set zai glm-4.6"
            echo "  claudeswap setup"
            echo ""
            ;;
        *)
            if [[ -z "$command" ]]; then
                log_error "No command specified"
            else
                log_error "Unknown command: $command"
            fi
            echo "Use 'claudeswap help' for usage information"
            return 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
